---
title: "Verifying container image signature with Kubernetes admission tools"
description: "Verifying container image integrity and signature before deploying to Kubernetes Cluster with Ratify and Kyverno"
type: docs
weight: 2
---
Digital signatures offer a way for software consumers to verify that the downloaded container image is from a trusted source and has not been tampered with. This verification process is essential for ensuring the security and integrity of an image before using it. [Ratify](https://github.com/deislabs/ratify) and [Kyverno](https://github.com/kyverno/kyverno/) support verifying container images before deploying them into a Kubernetes cluster to protect against potential security risks. For more information on signing and verifying container images, please refer to [Sign and verify an image with Notation, Ratify, and OPA Gatekeeper](https://ratify.dev/blog/sign-and-verify-image-with-notation-ratify) and [Verifying Image Signatures](https://kyverno.io/docs/writing-policies/verify-images/notary/#verifying-image-signatures).

## Verify image signature with Notation CLI
 [Verify the image signature as a software consumer](https://ratify.dev/blog/sign-and-verify-image-with-notation-ratify/#verify-the-image-signature-as-a-software-consumer) with the Notation CLI before using it.

``` 
notation verify $IMAGE
```
You can also check the signature digest and inspect the signature and its certificate information to make sure the image is produced by a trusted identity.

```
notation inspect $IMAGE
```

## Verifying a container image with Ratify 
As a prerequisite, youâ€™ll need:
- Kubernetes v1.20 or higher (You can use [minikube](https://minikube.sigs.k8s.io/docs/start/) if you are new to Kubernetes)
- Helm v3

Using Ratify will ensure that only signed images are deployed to Kubernetes.
Set up Gatekeeper with [external data.](https://open-policy-agent.github.io/gatekeeper/website/docs/externaldata)

```console
helm repo add gatekeeper https://open-policy-agent.github.io/gatekeeper/charts

helm install gatekeeper/gatekeeper  \
   --name-template=gatekeeper \
   --namespace gatekeeper-system --create-namespace \
   --set enableExternalData=true \
   --set validatingWebhookTimeoutSeconds=5 \
   --set mutatingWebhookTimeoutSeconds=2
```
Install the lastest version of Ratify. Specify the certificate generated by Notation for verification purposes.

```console
helm repo add ratify https://deislabs.github.io/ratify

helm install ratify \
   ratify/ratify --atomic \
   --namespace gatekeeper-system \
   --set-file notaryCert=ghcr-networks.io.crt
```
Apply the constrait to enforce Gatekeeper policy to allow only signed images can be deployed on Kubernetes:

```console
kubectl apply -f https://deislabs.github.io/ratify/library/default/template.yaml
kubectl apply -f https://deislabs.github.io/ratify/library/default/samples/constraint.yaml
```
Deploy the sample image signed by Notation. Ratify will verify if this image has a valid signature.

```console
kubectl run ratify-signed --image=$IMAGE
/net-monitor@sha256:27c0290c485140c3c998e92c6ef23fba2bd9f09c8a1c7adb24a1d2d274ce3e8e
pod/demo created
```
Check the signature associated with the image.

```
notation ls $IMAGE
```
Deploy an unsigned image to Kubernetes cluster. The deployment has been denied since the image has not been signed and doesn't meet the deployment criteria.

```console
$ kubectl run demo --image=ghcr.io/feynmanzhou/notation/alpine@sha256:1304f174557314a7ed9eddb4eab12fed12cb0cd9809e4c28f29af86979a3c870
```
Output:
```
Error from server (Forbidden): admission webhook "validation.gatekeeper.sh" denied the request: [ratify-constraint] Subject failed verification: ghcr.io/feynmanzhou/notation/alpine@sha256:1304f174557314a7ed9eddb4eab12fed12cb0cd9809e4c28f29af86979a3c870
```
Inspect the logs to get the detailed error message from the Ratify Pod.

```json 
$ kubectl logs ratify-xxxx -n gatekeeper-system
{
     "subject": "ghcr.io/feynmanzhou/notation/alpine@sha256:1304f174557314a7ed9eddb4eab12fed12cb0cd9809e4c28f29af86979a3c870",
     "isSuccess": false,
     "message": "verification failed: no referrers found for this artifact"
   }
```
Deploy a signed image with an expired certificate.

```console
kubectl run sample --image=ghcr.io/feynmanzhou/alpine:latest@sha256:1304f174557314a7ed9eddb4eab12fed12cb0cd9809e4c28f29af86979a3c870
```

Output:
```
Error from server (Forbidden): admission webhook "validation.gatekeeper.sh" denied the request: [ratify-constraint] Subject failed verification: ghcr.io/feynmanzhou/alpine:latest@sha256:1304f174557314a7ed9eddb4eab12fed12cb0cd9809e4c28f29af86979a3c870
```
Inspect the logs to get the detailed error message from the Ratify Pod. You can find that verification failed caused by an invalid signature.

```json
{
 "isSuccess": false,
 "verifierReports": [
   {
     "isSuccess": false,
     "name": "notaryv2",
     "message": "an error thrown by the verifier: failed to verify signature, err: signature is not produced by a trusted signer",
```

## Verifying image signatures with Kyverno

The following policy checks whether an image is signed with a valid X.509 key that matches the provided public certificate:

```yaml
apiVersion: kyverno.io/v2beta1
kind: ClusterPolicy
metadata:
  name: check-image-notary
spec:
  validationFailureAction: Enforce
  webhookTimeoutSeconds: 30
  failurePolicy: Fail  
  rules:
    - name: verify-signature-notary
      match:
        any:
        - resources:
            kinds:
              - Pod
      verifyImages:
      - type: Notary
        imageReferences:
        - "ghcr.io/kyverno/test-verify-image*"
        attestors:
        - count: 1
          entries:
          - certificates:
              cert: |-
                -----BEGIN CERTIFICATE-----
                MIIDTTCCAjWgAwIBAgIJAPI+zAzn4s0xMA0GCSqGSIb3DQEBCwUAMEwxCzAJBgNV
                BAYTAlVTMQswCQYDVQQIDAJXQTEQMA4GA1UEBwwHU2VhdHRsZTEPMA0GA1UECgwG
                Tm90YXJ5MQ0wCwYDVQQDDAR0ZXN0MB4XDTIzMDUyMjIxMTUxOFoXDTMzMDUxOTIx
                MTUxOFowTDELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAldBMRAwDgYDVQQHDAdTZWF0
                dGxlMQ8wDQYDVQQKDAZOb3RhcnkxDTALBgNVBAMMBHRlc3QwggEiMA0GCSqGSIb3
                DQEBAQUAA4IBDwAwggEKAoIBAQDNhTwv+QMk7jEHufFfIFlBjn2NiJaYPgL4eBS+
                b+o37ve5Zn9nzRppV6kGsa161r9s2KkLXmJrojNy6vo9a6g6RtZ3F6xKiWLUmbAL
                hVTCfYw/2n7xNlVMjyyUpE+7e193PF8HfQrfDFxe2JnX5LHtGe+X9vdvo2l41R6m
                Iia04DvpMdG4+da2tKPzXIuLUz/FDb6IODO3+qsqQLwEKmmUee+KX+3yw8I6G1y0
                Vp0mnHfsfutlHeG8gazCDlzEsuD4QJ9BKeRf2Vrb0ywqNLkGCbcCWF2H5Q80Iq/f
                ETVO9z88R7WheVdEjUB8UrY7ZMLdADM14IPhY2Y+tLaSzEVZAgMBAAGjMjAwMAkG
                A1UdEwQCMAAwDgYDVR0PAQH/BAQDAgeAMBMGA1UdJQQMMAoGCCsGAQUFBwMDMA0G
                CSqGSIb3DQEBCwUAA4IBAQBX7x4Ucre8AIUmXZ5PUK/zUBVOrZZzR1YE8w86J4X9
                kYeTtlijf9i2LTZMfGuG0dEVFN4ae3CCpBst+ilhIndnoxTyzP+sNy4RCRQ2Y/k8
                Zq235KIh7uucq96PL0qsF9s2RpTKXxyOGdtp9+HO0Ty5txJE2txtLDUIVPK5WNDF
                ByCEQNhtHgN6V20b8KU2oLBZ9vyB8V010dQz0NRTDLhkcvJig00535/LUylECYAJ
                5/jn6XKt6UYCQJbVNzBg/YPGc1RF4xdsGVDBben/JXpeGEmkdmXPILTKd9tZ5TC0
                uOKpF5rWAruB5PCIrquamOejpXV9aQA/K2JQDuc0mcKz
                -----END CERTIFICATE-----                
```
With this policy configured, Kyverno will verify matching container image signatures and only allow the pod to be configured if the signatures are valid:

```console
kubectl run test --image=ghcr.io/kyverno/test-verify-image:signed --dry-run=server
pod/test created (server dry run)
```
Kyverno will also mutate the pod to replace the image tag with its digest:

```console
kubectl run test --image=ghcr.io/kyverno/test-verify-image:signed --dry-run=server -o yaml | grep "image: "
  - image: ghcr.io/kyverno/test-verify-image:signed@sha256:b31bfb4d0213f254d361e0079deaaebefa4f82ba7aa76ef82e90b4935ad5b105
```

Attempting to run a pod with an unsigned image will be blocked:

```console
kubectl run test --image=ghcr.io/kyverno/test-verify-image:unsigned --dry-run=server
Error from server: admission webhook "mutate.kyverno.svc-fail" denied the request:

resource Pod/default/test was blocked due to the following policies

check-image-notary:
  verify-signature-notary: 'failed to verify image ghcr.io/kyverno/test-verify-image:unsigned:
    .attestors[0].entries[0]: failed to verify ghcr.io/kyverno/test-verify-image@sha256:74a98f0e4d750c9052f092a7f7a72de7b20f94f176a490088f7a744c76c53ea5:
    no signature is associated with "ghcr.io/kyverno/test-verify-image@sha256:74a98f0e4d750c9052f092a7f7a72de7b20f94f176a490088f7a744c76c53ea5",
    make sure the image was signed successfully'
```